# Phase 19 Specification: The Intelligent Nudge

> **Goal:** Connect the "Brain" (Pattern Detection) to the "Voice" (Notifications) to create a proactive agent.
> **Philosophy:** A good assistant doesn't just nag you at the same time every day; they notice when you're busy or tired and adapt.

---

## 1. The Concept: "The Drift"

Users often set a habit for 8:00 AM but consistently do it at 9:15 AM.
* **Current State:** App notifies at 8:00 AM. User ignores it. App becomes noise.
* **Desired State:** App detects the "Drift" (median completion time = 9:15 AM) and suggests: *"You usually do this at 9:15 AM. Want to update your reminder?"*

## 2. The Concept: "Contextual Empathy"

We know *why* users miss (from Phase 14 data). We should use this.
* **Scenario:** User has "Low Energy" pattern detected.
* **Old Notification:** "Time for your Workout!"
* **New Notification:** "Feeling tired? Just do 1 pushup. Keep the vote cast."

---

## 3. Technical Architecture

### A. New Logic: `OptimizedTimeFinder`
Create `lib/data/services/smart_nudge/optimized_time_finder.dart`.

* **Input:** `List<DateTime> completionHistory` (from last 30 days).
* **Algorithm:**
    1.  Filter out outliers (times > 2 hours away from mean).
    2.  Calculate **Median** time of day (more robust than Average).
    3.  Compare Median to `scheduledTime`.
    4.  **Trigger:** If `difference.abs() > 45 minutes`, flag as `DriftDetected`.

### B. Modified Service: `NotificationService`
Modify `lib/data/notification_service.dart`.

* **Add method:** `scheduleSmartReminder(Habit habit, List<HabitPattern> activePatterns)`
* **Logic:**
    * Check `activePatterns` for that habit.
    * **If `Energy Gap` pattern:** Change Body text to "Tiny Version" copy.
    * **If `Morning Struggle` pattern:** Change Body text to "Don't aim for perfect, just show up."
    * **If `Weekend Wobble`:** Add specific "Weekend Warrior" encouragement on Sat/Sun.

### C. UI: The Suggestion Dialog
Reuse `SuggestionDialog` or `ImprovementSuggestionsDialog` (from Phase 14/15).

* **Trigger:** On `TodayScreen` refresh or `WeeklyReview`.
* **Content:**
    * "Time Update Found: You're naturally doing this at 9:15 AM."
    * **Action:** "Update Time" (updates Habit model + reschedules notification).

---

## 4. Implementation Steps

### Step 1: The Math (Pure Dart)
1.  Create `OptimizedTimeFinder` class.
2.  Write unit tests with various `completionHistory` datasets (perfect consistency, wild chaos, slight drift).
3.  Ensure it handles crossing midnight correctly (e.g., 11 PM vs 1 AM).

### Step 2: The Service Layer
1.  Update `NotificationService` to accept a custom `body` text override.
2.  Create a `NudgeCopywriter` static helper class that returns strings based on `PatternType`.
    * *Input:* `PatternType.lowEnergy` -> *Output:* "Low energy day? Do the tiny version."

### Step 3: The Integration
1.  In `TodayScreenController.loadData()`:
    * Run `OptimizedTimeFinder` on the habit.
    * If drift detected && not prompted recently -> Show Dialog.
2.  In `WeeklyReviewService`:
    * Add a step "Schedule Optimization" that lists habits with significant Drift.

---

## 5. Acceptance Criteria

* [ ] **Unit Test:** `OptimizedTimeFinder` correctly identifies a 9:00 AM habit drifting to 9:45 AM.
* [ ] **Unit Test:** `OptimizedTimeFinder` ignores random one-off 4:00 PM completions.
* [ ] **UI:** User sees a dialog suggesting a time change if they are consistently late.
* [ ] **Feature:** Notification text changes based on the user's "Miss Reason" history (simulated).

---

## 6. Tiered Architecture (Freemium Model)

### Free Tier: Local Heuristics
- `OptimizedTimeFinder` runs locally
- `NudgeCopywriter` uses static pattern-based copy
- Basic drift detection with 45-minute threshold
- Pattern-aware notifications

### Premium Tier: AI-Enhanced (DeepSeek)
- Personalized notification copy generated by AI
- More nuanced drift analysis considering:
  - Day of week patterns
  - Seasonal variations
  - Life event detection
- Smart suggestions with explanations

### Premium+ Tier: Claude Integration
- Full conversational coaching
- Proactive intervention suggestions
- Cross-habit correlation analysis
- "Life Coach" mode with deep behavioral insights

---

## 7. Data Flow

```
┌─────────────────────┐
│  completionHistory  │ (from Habit model)
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ OptimizedTimeFinder │ (Pure Dart math)
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│    DriftAnalysis    │ (medianTime, drift, shouldSuggest)
└──────────┬──────────┘
           │
     ┌─────┴─────┐
     ▼           ▼
┌─────────┐ ┌─────────────────┐
│ Dialog  │ │ NudgeCopywriter │
│ (UI)    │ │ (Notifications) │
└─────────┘ └─────────────────┘
```

---

## 8. Key Files to Create/Modify

### New Files:
- `lib/data/services/smart_nudge/optimized_time_finder.dart`
- `lib/data/services/smart_nudge/nudge_copywriter.dart`
- `lib/data/services/smart_nudge/drift_analysis.dart`
- `lib/widgets/time_drift_suggestion_dialog.dart`
- `test/unit/optimized_time_finder_test.dart`

### Modified Files:
- `lib/data/notification_service.dart`
- `lib/features/today/controllers/today_screen_controller.dart`
- `lib/data/services/weekly_review_service.dart`
